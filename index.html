<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <title>EV Route – Seuraava lataus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { height: 45vh; height: 45svh; height: 45dvh; min-height: 260px; width: 100%; }
    main { padding: 10px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .grow { flex: 1; min-width: 210px; }
    button { padding: 9px 12px; border-radius: 10px; border: none; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .primary { background: #2563eb; color: #fff; }
    .ghost { background: #f1f5f9; color: #0f172a; }
    .pill { background: #f1f5f9; padding: 6px 10px; border-radius: 999px; font-size: 14px; display:flex; gap:8px; align-items:center;}
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 8px; }
    .meta { display: flex; gap: 6px; flex-wrap: wrap; font-size: 13px; margin-top:6px;}
    .small { font-size: 13px; }
    .warn { color: #b45309; }
    .error { color: #b91c1c; }
    input { padding: 9px 10px; border: 1px solid #e5e7eb; border-radius: 10px; }
    .pill input { padding: 4px 6px; border-radius: 8px; }
    #debug { margin-top:10px; white-space:pre-wrap; background:#f8fafc; padding:10px; border-radius:12px; border:1px solid #e5e7eb; max-height: 220px; overflow:auto; display:none; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  </style>
</head>
<body>

<div id="map"></div>

<main>
  <div class="row">
    <input id="fromCity" class="grow" placeholder="Lähtökaupunki (jos GPS ei toimi)" />
    <input id="toCity" class="grow" placeholder="Määränpää (esim. Turku)" />
  </div>

  <div class="row" style="margin-top:8px;">
    <label class="pill">Akkua (km) <input id="rangeKm" type="number" inputmode="numeric" value="120" style="width:90px;"></label>
    <label class="pill">Vara (km) <input id="reserveKm" type="number" inputmode="numeric" value="20" style="width:80px;"></label>
    <label class="pill">Hakusäde (km) <input id="radiusKm" type="number" inputmode="numeric" value="40" style="width:80px;"></label>

    <button id="btnFind" class="primary">Etsi seuraava lataus</button>
    <button id="btnRetry" class="ghost" style="display:none;">Yritä uudelleen</button>
    <button id="btnHardReload" class="ghost" title="Jos iPhone näyttää vanhaa versiota">Päivitä “kovaa”</button>
    <button id="btnDebug" class="ghost">Debug</button>
  </div>

  <div class="row" style="margin-top:8px;">
    <input id="operatorFilter" class="grow" placeholder="Salli operaattorit (pilkuilla), esim. Tesla, Ionity, K-Lataus (tyhjä = kaikki)" />
  </div>

  <div id="status" class="small" style="margin-top:8px;"></div>

  <div class="actions" id="fallbackActions" style="display:none;">
    <button id="btnShowLast" class="ghost">Näytä viimeisin onnistunut tulos</button>
    <button id="btnClearLast" class="ghost">Tyhjennä viimeisin tulos</button>
  </div>

  <div id="list" style="margin-top:10px;"></div>
  <pre id="debug" class="small"></pre>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ------------------ CONFIG ------------------ */
var OCM_PROXY_BASE = "https://ev-route-chargers.vercel.app/api/ocm";
var LAST_KEY = "ev_route_last_success_v3";

/* ------------------ DEBUG ------------------ */
var elDebug = document.getElementById("debug");
function dbg() {
  var args = Array.prototype.slice.call(arguments);
  var line = args.map(function(a){
    if (typeof a === "string") return a;
    try { return JSON.stringify(a); } catch (e) { return String(a); }
  }).join(" ");
  elDebug.textContent += line + "\n";
  elDebug.scrollTop = elDebug.scrollHeight;
}
dbg("SCRIPT LOADED");
window.addEventListener("error", function(e){ dbg("JS ERROR:", e.message); });
window.addEventListener("unhandledrejection", function(e){ dbg("PROMISE ERROR:", String(e.reason)); });

function debugTopPOIs(pois) {
  if (!Array.isArray(pois)) { dbg("DEBUG POI: pois is not an array"); return; }
  dbg("DEBUG POI: total returned =", String(pois.length));
  pois.slice(0,10).forEach(function(p, i){
    var title = (p.AddressInfo && p.AddressInfo.Title) ? p.AddressInfo.Title : "(no title)";
    var operator = (p.OperatorInfo && p.OperatorInfo.Title) ? p.OperatorInfo.Title : "(no operator)";
    var conns = p.Connections || [];
    var maxPower = 0;
    for (var k=0;k<conns.length;k++) {
      var pw = Number(conns[k].PowerKW) || 0;
      if (pw > maxPower) maxPower = pw;
    }
    var isDC = false;
    for (var j=0;j<conns.length;j++) {
      var c = conns[j] || {};
      var lvl = Number(c.LevelID);
      var ct = (c.CurrentType && c.CurrentType.Title) ? String(c.CurrentType.Title).toUpperCase() : "";
      if (lvl === 3 || ct.indexOf("DC") >= 0) { isDC = true; break; }
    }
    dbg("#"+String(i+1), "|", title, "| operator:", operator, "| maxPower:", String(maxPower), "| DC:", String(isDC));
  });
}

/* ------------------ UI ------------------ */
var elFrom = document.getElementById('fromCity');
var elTo = document.getElementById('toCity');
var elRange = document.getElementById('rangeKm');
var elReserve = document.getElementById('reserveKm');
var elRadius = document.getElementById('radiusKm');
var elOperatorFilter = document.getElementById('operatorFilter');

var elBtn = document.getElementById('btnFind');
var elBtnRetry = document.getElementById('btnRetry');
var elBtnHardReload = document.getElementById('btnHardReload');
var elBtnDebug = document.getElementById('btnDebug');

var elStatus = document.getElementById('status');
var elList = document.getElementById('list');

var elFallbackActions = document.getElementById('fallbackActions');
var elBtnShowLast = document.getElementById('btnShowLast');
var elBtnClearLast = document.getElementById('btnClearLast');

function setStatus(msg, cls) {
  cls = cls || "";
  elStatus.className = "small " + cls;
  elStatus.textContent = msg;
  dbg("STATUS:", msg);
}
function setBusy(isBusy) {
  elBtn.disabled = isBusy;
  elBtnRetry.disabled = isBusy;
}
function showRetry(show) { elBtnRetry.style.display = show ? "inline-block" : "none"; }
function showFallbackActions(show) { elFallbackActions.style.display = show ? "flex" : "none"; }

elBtnDebug.onclick = function() {
  elDebug.style.display = (elDebug.style.display === "block") ? "none" : "block";
  dbg("Debug toggled");
};

elBtnHardReload.onclick = function() {
  // cache-buster URL
  var u = new URL(location.href);
  u.searchParams.set("v", String(Date.now()));
  location.href = u.toString();
};

/* ------------------ MAP ------------------ */
var map = null, layer = null;
function initMap() {
  map = L.map('map').setView([60.1699, 24.9384], 6);
  var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap' }).addTo(map);
  tiles.on('tileerror', function(){ dbg("TILE ERROR"); });
  layer = L.layerGroup().addTo(map);
  setTimeout(function(){ try { map.invalidateSize(); dbg("invalidateSize OK"); } catch(e){} }, 300);
}
function safeFitBounds() {
  try {
    var bounds = layer.getBounds && layer.getBounds();
    if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds, { padding:[20,20] });
  } catch (e) { dbg("fitBounds error:", e && e.message ? e.message : String(e)); }
}

/* ------------------ HELPERS ------------------ */
function haversineKm(lat1, lon1, lat2, lon2) {
  var R = 6371;
  var dLat = (lat2-lat1) * Math.PI/180;
  var dLon = (lon2-lon1) * Math.PI/180;
  var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
async function geocode(name) {
  var url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(name);
  var r = await fetch(url);
  var j = await r.json();
  if (!j[0]) return null;
  return { lat: +j[0].lat, lon: +j[0].lon };
}
async function getStart() {
  return new Promise(function(resolve){
    if (!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      function(p){ resolve({ lat: p.coords.latitude, lon: p.coords.longitude }); },
      function(){ resolve(null); },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}
async function fetchRoute(start, end) {
  var url = "https://router.project-osrm.org/route/v1/driving/" +
    String(start.lon) + "," + String(start.lat) + ";" + String(end.lon) + "," + String(end.lat) +
    "?overview=full&geometries=geojson";
  var r = await fetch(url);
  var j = await r.json();
  return j.routes[0].geometry.coordinates;
}
function pointAlongRoute(coords, km) {
  var acc = 0;
  for (var i=1;i<coords.length;i++) {
    var a = coords[i-1], b = coords[i];
    var d = haversineKm(a[1],a[0],b[1],b[0]);
    if (acc + d >= km) {
      var t = (km - acc)/d;
      return { lat: a[1] + (b[1]-a[1])*t, lon: a[0] + (b[0]-a[0])*t };
    }
    acc += d;
  }
  var last = coords[coords.length-1];
  return { lat:last[1], lon:last[0] };
}
function sleep(ms) { return new Promise(function(r){ setTimeout(r, ms); }); }

async function fetchJsonWithTimeout(url, timeoutMs) {
  var controller = new AbortController();
  var t = setTimeout(function(){ controller.abort(); }, timeoutMs);
  try {
    var r = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store", signal: controller.signal });
    var text = await r.text();

    var s = text.trim().toLowerCase();
    var looksHtml = s.indexOf("<!doctype html") === 0 || s.indexOf("<html") === 0;
    if (looksHtml) { var err1 = new Error("OCM returned HTML (likely 524 timeout)"); err1.status = 524; throw err1; }

    var json;
    try { json = JSON.parse(text); }
    catch (e) { var err2 = new Error("Invalid JSON from proxy"); err2.status = r.status; throw err2; }

    if (!r.ok) {
      var msg = (json && json.error) ? json.error : ("HTTP " + String(r.status));
      var err3 = new Error(msg);
      err3.status = r.status;
      err3.json = json;
      throw err3;
    }
    return json;
  } finally {
    clearTimeout(t);
  }
}

async function fetchOCM(lat, lon, km, maxresults) {
  maxresults = maxresults || 25;
  var p = new URLSearchParams({
    latitude: String(lat),
    longitude: String(lon),
    distance: String(km),
    distanceunit: "KM",
    maxresults: String(maxresults)
  });
  var url = OCM_PROXY_BASE + "?" + p.toString();
  dbg("OCM URL:", url);

  var lastErr = null;
  for (var i = 1; i <= 3; i++) {
    try { return await fetchJsonWithTimeout(url, 18000); }
    catch (e) {
      lastErr = e;
      dbg("OCM try failed:", String(e && e.message ? e.message : e), "status:", String(e && e.status ? e.status : ""));
      if (i < 3) await sleep(500 * i);
    }
  }
  throw lastErr;
}

/* ------------------ OPERATOR FILTER ------------------ */
function parseOperatorAllowlist() {
  var raw = String(elOperatorFilter.value || "").trim();
  if (!raw) return [];
  return raw.split(",").map(function(s){ return s.trim(); }).filter(Boolean);
}
function operatorMatches(allow, opTitle, stationTitle) {
  if (!allow.length) return true;
  var hay = (String(opTitle || "") + " " + String(stationTitle || "")).toLowerCase();
  return allow.some(function(a){ return hay.indexOf(a.toLowerCase()) >= 0; });
}

/* ------------------ RESULTS ------------------ */
function clearUIForSearch() {
  layer.clearLayers();
  elList.innerHTML = "";
  showRetry(false);
  showFallbackActions(false);
}
function renderResults(final, suffix) {
  suffix = suffix || "";
  elList.innerHTML = "";
  final.forEach(function(r){
    L.circleMarker([r.lat,r.lon], { radius:8, color:"green", fillOpacity:0.9 })
      .addTo(layer)
      .bindPopup("<b>"+r.title+"</b><br>"+Math.round(r.maxPower)+" kW<br>"+r.dist.toFixed(1)+" km<br>"+(r.operator ? ("<i>"+r.operator+"</i>") : ""));

    var card = document.createElement("div");
    card.className = "card";
    card.innerHTML =
      "<b>"+r.title+"</b>" +
      "<div class='meta'>" +
        "<span class='pill'>"+Math.round(r.maxPower)+" kW</span>" +
        "<span class='pill'>"+r.dist.toFixed(1)+" km</span>" +
        (r.operator ? "<span class='pill'>"+r.operator+"</span>" : "") +
      "</div>" +
      "<button class='primary' style='margin-top:8px;'>Navigoi</button>";

    card.querySelector("button").onclick = function() {
      window.open("https://www.google.com/maps/dir/?api=1&destination=" + r.lat + "," + r.lon, "_blank");
    };
    elList.appendChild(card);
  });

  safeFitBounds();
  setStatus("Löytyi " + String(final.length) + " latauspaikkaa." + suffix);
}

function mapPoisToResults(pois, target, allowOps) {
  var mapped = (pois || []).map(function(p){
    var ai = p.AddressInfo || {};
    var conns = p.Connections || [];
    var maxPower = 0;
    for (var i=0;i<conns.length;i++) {
      var pw = Number(conns[i].PowerKW) || 0;
      if (pw > maxPower) maxPower = pw;
    }
    var isDC = false;
    for (var j=0;j<conns.length;j++) {
      var c = conns[j] || {};
      var lvl = Number(c.LevelID);
      var ct = (c.CurrentType && c.CurrentType.Title) ? String(c.CurrentType.Title).toUpperCase() : "";
      if (lvl === 3 || ct.indexOf("DC") >= 0) { isDC = true; break; }
    }
    var operator = (p.OperatorInfo && p.OperatorInfo.Title) ? p.OperatorInfo.Title : "";
    var lat = Number(ai.Latitude);
    var lon = Number(ai.Longitude);

    return {
      title: ai.Title || "Nimetön latauspaikka",
      lat: lat,
      lon: lon,
      maxPower: maxPower,
      isDC: isDC,
      operator: operator,
      dist: haversineKm(target.lat, target.lon, lat, lon)
    };
  }).filter(function(x){ return Number.isFinite(x.lat) && Number.isFinite(x.lon) && x.isDC; });

  var filteredByOp = mapped.filter(function(x){ return operatorMatches(allowOps, x.operator, x.title); });

  var fast = filteredByOp.filter(function(x){ return x.maxPower >= 150; });
  var base = fast.length ? fast : filteredByOp;

  base.sort(function(a,b){
    if (b.maxPower !== a.maxPower) return b.maxPower - a.maxPower;
    return a.dist - b.dist;
  });

  var final = base.slice(0,5);
  return { mapped: mapped, filteredByOp: filteredByOp, fastCount: fast.length, final: final };
}

/* ------------------ LAST SUCCESS ------------------ */
function saveLast(payload) { try { localStorage.setItem(LAST_KEY, JSON.stringify(payload)); } catch(e){} }
function loadLast() { try { var s = localStorage.getItem(LAST_KEY); return s ? JSON.parse(s) : null; } catch(e){ return null; } }
function clearLast() { try { localStorage.removeItem(LAST_KEY); } catch(e){} }

function showLastIfAvailable() {
  var last = loadLast();
  if (!last) return setStatus("Ei tallennettua aiempaa tulosta.", "warn");

  layer.clearLayers();
  elList.innerHTML = "";

  if (last.route) L.geoJSON({ type:"LineString", coordinates: last.route }, { color:"#2563eb", weight:4 }).addTo(layer);
  if (last.target) L.circleMarker([last.target.lat, last.target.lon], { radius:8, color:"#f59e0b", fillOpacity:0.9 })
    .addTo(layer).bindPopup("<b>Seuraava lataus</b><br>" + (last.usableKm ? String(Math.round(last.usableKm)) : "") + " km");

  if (last.results) renderResults(last.results, " (viimeisin onnistunut)");
  else setStatus("Tallennettu tulos oli puutteellinen.", "warn");
}

/* ------------------ MAIN ------------------ */
async function runSearch() {
  clearUIForSearch();
  setBusy(true);

  var toName = String(elTo.value || "").trim();
  if (!toName) { setBusy(false); return setStatus("Anna määränpää.", "warn"); }

  var usableKm = Math.max(0, Number(elRange.value) - Number(elReserve.value));
  if (usableKm <= 0) { setBusy(false); return setStatus("Akkua − vara = 0 km. Pienennä varaa tai nosta akkua.", "warn"); }

  try {
    setStatus("Haetaan lähtö ja määränpää…");

    var start = await getStart();
    if (!start) {
      var fromName = String(elFrom.value || "").trim();
      if (!fromName) { setBusy(false); return setStatus("GPS ei käytettävissä – anna lähtökaupunki.", "warn"); }
      start = await geocode(fromName);
      if (!start) { setBusy(false); return setStatus("Lähtöpaikkaa ei löytynyt. Tarkista kirjoitusasu.", "warn"); }
    }

    var end = await geocode(toName);
    if (!end) { setBusy(false); return setStatus("Määränpäätä ei löytynyt. Tarkista kirjoitusasu (esim. Turku).", "warn"); }

    setStatus("Haetaan reitti…");
    var route = await fetchRoute(start, end);

    L.geoJSON({ type:"LineString", coordinates: route }, { color:"#2563eb", weight:4 }).addTo(layer);

    var target = pointAlongRoute(route, usableKm);
    L.circleMarker([target.lat, target.lon], { radius:8, color:"#f59e0b", fillOpacity:0.9 })
      .addTo(layer).bindPopup("<b>Seuraava lataus</b><br>" + String(Math.round(usableKm)) + " km");

    setTimeout(function(){ try { map.invalidateSize(); } catch(e){} }, 50);
    safeFitBounds();

    setStatus("Haetaan latauspisteet…");

    var allowOps = parseOperatorAllowlist();
    var radiusKm = Number(elRadius.value);

    var pois;
    try {
      pois = await fetchOCM(target.lat, target.lon, radiusKm, 25);
      debugTopPOIs(pois);
    } catch (e) {
      var status = e && e.status ? e.status : null;
      var msg = String(e && e.message ? e.message : e);
      dbg("OCM primary failed:", msg, "status:", String(status || ""));

      if (status === 524 || status === 503 || status === 504 || msg.toLowerCase().indexOf("timeout") >= 0) {
        setStatus("OCM ruuhkassa – kokeillaan pienemmällä haulla…", "warn");
        var smaller = Math.max(10, Math.round(radiusKm * 0.6));
        pois = await fetchOCM(target.lat, target.lon, smaller, 15);
        debugTopPOIs(pois);
      } else {
        throw e;
      }
    }

    var r = mapPoisToResults(pois, target, allowOps);
    var mapped = r.mapped, filteredByOp = r.filteredByOp, fastCount = r.fastCount, final = r.final;

    if (!mapped.length) {
      setBusy(false);
      setStatus("Ei löytynyt DC-latureita tällä haulla. Kokeile isompaa hakusädettä.", "warn");
      showFallbackActions(!!loadLast());
      return;
    }

    if (allowOps.length && !filteredByOp.length) {
      setBusy(false);
      setStatus("Operaattorisuodatus poisti kaikki tulokset. Laajenna listaa tai tyhjennä suodatin.", "warn");
      showFallbackActions(!!loadLast());
      return;
    }

    if (!final.length) {
      setBusy(false);
      setStatus("Ei löytynyt sopivia latauspaikkoja tällä haulla. Kokeile isompaa hakusädettä.", "warn");
      showFallbackActions(!!loadLast());
      return;
    }

    saveLast({ route: route, target: target, usableKm: usableKm, results: final, savedAt: Date.now() });

    var suffix = "";
    if (final.length < 5) suffix += " (näytetään " + String(final.length) + "/5 – kokeile isompaa hakusädettä)";
    if (!fastCount) suffix += " (ei ≥150 kW osumia – näytetään parhaat DC-laturit)";

    renderResults(final, suffix);
    setBusy(false);

  } catch (e) {
    dbg("CATCH:", String(e && e.message ? e.message : e), "status:", String(e && e.status ? e.status : ""));
    showRetry(true);
    showFallbackActions(!!loadLast());

    var msg2 = String(e && e.message ? e.message : e);
    if (msg2.toLowerCase().indexOf("ocm") >= 0) setStatus("OCM ei vastannut nyt (ruuhka/timeout). Yritä uudelleen hetken päästä.", "error");
    else setStatus("Haku epäonnistui: " + msg2, "error");

    setBusy(false);
  }
}

/* ------------------ BUTTONS ------------------ */
elBtn.onclick = runSearch;
elBtnRetry.onclick = runSearch;

elBtnShowLast.onclick = function(){ showLastIfAvailable(); };
elBtnClearLast.onclick = function(){ clearLast(); setStatus("Viimeisin tulos tyhjennetty.", "warn"); showFallbackActions(false); };

document.addEventListener("DOMContentLoaded", function(){
  try { initMap(); } catch (e) { dbg("MAP INIT ERROR:", String(e)); }
  setStatus("Valmis. Syötä määränpää ja hae seuraava lataus.");
});
</script>
</body>
</html>
